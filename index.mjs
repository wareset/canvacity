/* eslint-disable */
var e=(e,t)=>{e.drawImage.apply(e,t)},t=(e,t,a,s)=>{e.beginPath(),s&&(a.beginPath(),s.beginPath())},a=(e,t,a,s)=>{e.clip.apply(e,t),s&&(a.clip.apply(a,t),s.clip.apply(s,t))},s=(e,t,a,s)=>{e.fill.apply(e,t),s&&(a.fill.apply(a,t),s.fill.apply(s,t))},i=(e,t,a,s)=>{e.stroke.apply(e,t),s&&(a.stroke.apply(a,t),s.stroke.apply(s,t))},r=(e,t)=>{e.putImageData.apply(e,t)},h=(e,t,a,s)=>{e.arc.apply(e,t),s&&(a.arc.apply(a,t),s.arc.apply(s,t))},l=(e,t,a,s)=>{e.arcTo.apply(e,t),s&&(a.arcTo.apply(a,t),s.arcTo.apply(s,t))},n=(e,t,a,s)=>{e.bezierCurveTo.apply(e,t),s&&(a.bezierCurveTo.apply(a,t),s.bezierCurveTo.apply(s,t))},p=(e,t,a,s)=>{e.closePath(),s&&(a.closePath(),s.closePath())},c=(e,t,a,s)=>{e.ellipse.apply(e,t),s&&(a.ellipse.apply(a,t),s.ellipse.apply(s,t))},o=(e,t,a,s)=>{e.lineTo.apply(e,t),s&&(a.lineTo.apply(a,t),s.lineTo.apply(s,t))},u=(e,t,a,s)=>{e.moveTo.apply(e,t),s&&(a.moveTo.apply(a,t),s.moveTo.apply(s,t))},d=(e,t,a,s)=>{e.quadraticCurveTo.apply(e,t),s&&(a.quadraticCurveTo.apply(a,t),s.quadraticCurveTo.apply(s,t))},_=(e,t,a,s)=>{e.rect.apply(e,t),s&&(a.rect.apply(a,t),s.rect.apply(s,t))},y=(e,t,a,s)=>{e.roundRect.apply(e,t),s&&(a.roundRect.apply(a,t),s.roundRect.apply(s,t))},f=(e,t,a,s)=>{e.setLineDash.apply(e,t),s&&(a.setLineDash.apply(a,t),s.setLineDash.apply(s,t))},v=(e,t,a,s)=>{e.clearRect.apply(e,t),s&&(a.clearRect.apply(a,t),s.clearRect.apply(s,t))},g=(e,t,a,s)=>{e.fillRect.apply(e,t),s&&(a.fillRect.apply(a,t),s.fillRect.apply(s,t))},x=(e,t,a,s)=>{e.strokeRect.apply(e,t),s&&(a.strokeRect.apply(a,t),s.strokeRect.apply(s,t))},m=(e,t,a,s)=>{e.fillText.apply(e,t),s&&(a.fillText.apply(a,t),s.fillText.apply(s,t))},T=(e,t,a,s)=>{e.strokeText.apply(e,t),s&&(a.strokeText.apply(a,t),s.strokeText.apply(s,t))},C=(e,t)=>{e.globalAlpha=t},R=(e,t)=>{e.globalCompositeOperation=t},w=(e,t)=>{e.fillStyle=t},b=(e,t)=>{e.strokeStyle=t},k=(e,t,a,s)=>{e.lineCap=t,s&&(a.lineCap=t,s.lineCap=t)},L=(e,t,a,s)=>{e.lineDashOffset=t,s&&(a.lineDashOffset=t,s.lineDashOffset=t)},D=(e,t,a,s)=>{e.lineJoin=t,s&&(a.lineJoin=t,s.lineJoin=t)},O=(e,t,a,s)=>{e.lineWidth=t,s&&(a.lineWidth=t,s.lineWidth=t)},I=(e,t,a,s)=>{e.miterLimit=t,s&&(a.miterLimit=t,s.miterLimit=t)},P=(e,t)=>{e.shadowBlur=t},A=(e,t)=>{e.shadowColor=t},B=(e,t)=>{e.shadowOffsetX=t},S=(e,t)=>{e.shadowOffsetY=t},z=(e,t,a,s)=>{e.font=t,s&&(a.font=t,s.font=t)},E=(e,t,a,s)=>{e.textAlign=t,s&&(a.textAlign=t,s.textAlign=t)},W=(e,t,a,s)=>{e.textBaseline=t,s&&(a.textBaseline=t,s.textBaseline=t)};class q{set globalAlpha(e){this._a.push([C,e])}set globalCompositeOperation(e){this._a.push([R,e])}drawImage(){this._a.push([e,arguments])}beginPath(){this._a.push([t])}clip(){this._a.push([a,arguments])}fill(){this._a.push([s,arguments])}stroke(){this._a.push([i,arguments])}set fillStyle(e){this._a.push([w,e])}set strokeStyle(e){this._a.push([b,e])}createLinearGradient(e,t,a,s){return this._c.createLinearGradient(e,t,a,s)}createPattern(e,t){return this._c.createPattern(e,t)}createRadialGradient(e,t,a,s,i,r){return this._c.createRadialGradient(e,t,a,s,i,r)}putImageData(){this._a.push([r,arguments])}arc(){this._a.push([h,arguments])}arcTo(){this._a.push([l,arguments])}bezierCurveTo(){this._a.push([n,arguments])}closePath(){this._a.push([p])}ellipse(){this._a.push([c,arguments])}lineTo(){this._a.push([o,arguments])}moveTo(){this._a.push([u,arguments])}quadraticCurveTo(){this._a.push([d,arguments])}rect(){this._a.push([_,arguments])}roundRect(){this._a.push([y,arguments])}set lineCap(e){this._a.push([k,e])}set lineDashOffset(e){this._a.push([L,e])}set lineJoin(e){this._a.push([D,e])}set lineWidth(e){this._a.push([O,e])}set miterLimit(e){this._a.push([I,e])}setLineDash(){this._a.push([f,arguments])}clearRect(){this._a.push([v,arguments])}fillRect(){this._a.push([g,arguments])}strokeRect(){this._a.push([x,arguments])}set shadowBlur(e){this._a.push([P,e])}set shadowColor(e){this._a.push([A,e])}set shadowOffsetX(e){this._a.push([B,e])}set shadowOffsetY(e){this._a.push([S,e])}fillText(){this._a.push([m,arguments])}measureText(e){return this._c.measureText(e)}strokeText(){this._a.push([T,arguments])}set font(e){this._a.push([z,e])}set textAlign(e){this._a.push([E,e])}set textBaseline(e){this._a.push([W,e])}}var G=()=>{},H=e=>{var t=0,a=0,s=e;return s>255&&(s-=255*(a=s/255|0),a>255&&(a-=255*(t=a/255|0))),`rgb(${t},${a},${s})`},J=(e,t,a)=>65025*e+255*t+a,X=Math.PI/180,Y=(e,t)=>{for(var a in t.renderer=e,t._events)e._event(a,!0);for(var s=t.children,i=s.length;i-- >0;)Y(e,s[i])},$=(e,t)=>{for(var a in t.renderer=null,t._events)e._event(a,!0);for(var s=t.children,i=s.length;i-- >0;)$(e,s[i])};class Layer{constructor(e){this.draw=e,this.renderer=null,this.parent=null,this.children=[],this.angle=0,this.scale={x:1,y:1},this.place={x:0,y:0},this.pivot={x:0,y:0},this._ecount=0,this._events={},this._ecolor1="",this._ecolor2="",this._transform=null,this._rendering=!1,this.shared={}}layer(e){var t=new Layer(e);return this.attach(t),t}render(){var e=this.renderer;if(e){var t,a,s=e.ctx,i=e._htx1,r=e._htx2,h=e._dtx;if(s.save(),i.save(),r.save(),h._a=[],h._c=s,h.layer=this,h.angle=this.angle,h.scale=this.scale,h.place=this.place,h.pivot=this.pivot,this.draw(h),this.parent&&!this.parent._rendering){var l=this.parent._transform;s.setTransform(l.a,l.b,l.c,l.d,l.e,l.f)}if(this.place=h.place,s.translate(h.place.x,h.place.y),this.scale=h.scale,s.scale(h.scale.x,h.scale.y),this.angle=h.angle,s.rotate(h.angle*X),this.pivot=h.pivot,s.translate(-h.pivot.x,-h.pivot.y),this._transform=s.getTransform(),this._ecount){var n=this._transform;e._rendering&&(this._ecolor1=H(e._layers.length),this._ecolor2=H(16e6-e._layers.length),e._layers.push(this)),t=i,a=r,i.fillStyle=this._ecolor1,i.strokeStyle=this._ecolor1,i.setTransform(n.a,n.b,n.c,n.d,n.e,n.f),r.fillStyle=this._ecolor2,r.strokeStyle=this._ecolor2,r.setTransform(n.a,n.b,n.c,n.d,n.e,n.f)}s.save(),i.save(),r.save();for(var p=h._a,c=0,o=p.length;c<o;c++)p[c][0](s,p[c][1],t,a);s.restore(),i.restore(),r.restore(),this._rendering=!0;for(var u=this.children,d=0;d<u.length;d++)u[d].render();this._rendering=!1,s.restore(),i.restore(),r.restore()}}attach(e,t){var a=this.renderer,s=this.children;if(e.parent!==this)e.detach(),e.parent=this,t===+t&&t<s.length?((t|=0)<0&&(t=0),s.splice(t,0,e)):s.push(e),a&&(a.update(),Y(a,this));else{var i=s.lastIndexOf(e);i!==(t=t===+t&&t<s.length?(t|=0)?0:t:s.length-(i<0?0:1))&&(i<0||s.splice(i,1),s.splice(t,0,e),a&&a.update())}}detach(){if(this.parent){var e=this.renderer,t=this.parent.children,a=t.lastIndexOf(this);a<0||t.splice(a,1),this.parent=null,e&&(e.update(),$(e,this))}}detachChildren(){for(var e=this.children,t=e.length;t-- >0;)e[t].detach()}event(e,t){var a=this._events[e];a||(this._events[e]=a={p:null,n:null},a.p=a.n=a);var s={p:null,n:null,f:t};return(s.p=(s.n=a).p).n=s.n.p=s,this._ecount++,this.renderer&&(this.renderer._event(e,!0),this.renderer.update()),()=>{s&&(this._ecount--,this.renderer&&this.renderer._event(e,!1),s.p.n=s.n,s.n.p=s.p,s.f=G,s=null)}}}function F(e,t,a,s,i){return(+e-(t=+t))*(+i-(s=+s))/(+a-t)+s}var M=(e,t)=>{var a=t.canvas,s=t._htx1,i=t._htx2,r=r=>{var h;if("clientX"in r?h=r:"touches"in r&&r.touches.length&&(h=r.touches[0]),h){null!==t._ucaf&&t.render();for(var l,n=a.getBoundingClientRect(),p=(0|F(h.clientX-n.left,0,a.clientWidth,0,a.width))-1,c=(0|F(h.clientY-n.top,0,a.clientHeight,0,a.height))-1,o=s.getImageData(p,c,3,3).data,u=i.getImageData(p,c,3,3).data,d=0,_=o.length;d<_;d+=4)if((l=J(o[d],o[d+1],o[d+2]))===16e6-J(u[d],u[d+1],u[d+2])){var y=t._layers[l];if(y)for(var f,v=!0;y&&v;y=y.parent)if(f=y._events&&y._events[e])for(var g=f;(g=g.n)!==f;)g.f.call(y,r,n)&&(v=!1);break}}else console.error("Bad Canvasity event: "+e)};return a.addEventListener(e,r),()=>{a&&(a.removeEventListener(e,r),a=null)}};class Renderer{constructor(e){this._dtx=new q,this.stage=new Layer(G),this.stage.renderer=this,this.stage._ecount=9,this._ucaf=null,this._update=()=>{this._ucaf=null,this.render()},this._layers=[],this._events={},this._rendering=!1,this.canvas=e||(e=document.createElement("canvas")),this.ctx=e.getContext("2d"),this._htx1=(this._hidden1=document.createElement("canvas")).getContext("2d",{alpha:!1}),this._htx2=(this._hidden2=document.createElement("canvas")).getContext("2d",{alpha:!1}),this.resize(e.width,e.height)}layer(e){return this.stage.layer(e)}resize(e,t){var a=this.canvas,s=this._hidden1,i=this._hidden2;a.width=e,a.height=t,s.width=e,s.height=t,i.width=e,i.height=t,this.update()}render(){var e=this.canvas,t=e.width,a=e.height;null!==this._ucaf&&(cancelAnimationFrame(this._ucaf),this._ucaf=null),this._layers=[],this._dtx.WIDTH=t,this._dtx.HEIGHT=a,this.ctx.clearRect(0,0,t,a),this._htx1.clearRect(0,0,t,a),this._htx2.clearRect(0,0,t,a),this._rendering=!0,this.stage.render(),this._rendering=!1}attach(e,t){this.stage.attach(e,t)}detachChildren(){this.stage.detachChildren()}update(){null===this._ucaf&&(this._ucaf=requestAnimationFrame(this._update))}_event(e,t){var a=this._events,s=a[e];t?(s||(a[e]=s={n:0,u:M(e,this)}),s.n++):s&&--s.n<1&&(s.u(),delete a[e])}}export{q as DrawContext,Layer,Renderer,Renderer as default};
